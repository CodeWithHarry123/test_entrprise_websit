<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Khatu Shyam Enterprises - Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;900&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="responsive.css" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#1173d4",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        display: ["Work Sans"],
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem",
                        lg: "0.5rem",
                        xl: "0.75rem",
                        full: "9999px"
                    },
                },
            },
        };
    </script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Firebase Init -->
    <script src="firebase-init.js"></script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
    <div class="relative flex min-h-screen flex-col justify-center overflow-hidden py-6 sm:py-12">
        <div
            class="relative bg-white dark:bg-background-dark px-6 pt-10 pb-8 shadow-xl ring-1 ring-gray-900/5 sm:mx-auto sm:max-w-lg sm:rounded-xl sm:px-10">
            <div class="mx-auto max-w-md">
                <div class="flex flex-col items-center">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-5xl">
                            local_shipping
                        </span>
                        <h2 class="text-2xl font-bold text-[#111418] dark:text-white">
                            Khatu Shyam Enterprises
                        </h2>
                    </div>
                </div>
                <div class="divide-y divide-gray-300/50 dark:divide-gray-700/50">
                    <div class="space-y-6 py-8 text-base leading-7 text-gray-600">
                        <div class="flex flex-col items-center">
                            <div class="flex flex-col gap-3 text-center">
                                <p class="text-[#111418] dark:text-white text-3xl font-black tracking-[-0.033em]">
                                    Welcome!
                                </p>
                                <p class="text-[#617589] dark:text-gray-400 text-base font-normal">
                                    Please enter your mobile number to continue.
                                </p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <label class="flex flex-col">
                                <p class="text-[#111418] dark:text-white text-sm font-medium pb-2">
                                    Mobile Number
                                </p>
                                <div class="flex">
                                    <select id="country-code-select"
                                        class="form-select rounded-l-lg border border-r-0 border-[#dbe0e6] bg-white dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:border-primary focus:ring-primary h-12 px-4 text-base">
                                        <option value="+91" selected>IN (+91)</option>
                                    </select>
                                    <input id="phone-number-input"
                                        class="form-input w-full rounded-r-lg border border-[#dbe0e6] bg-white dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:border-primary focus:ring-primary h-12 px-4 text-base"
                                        placeholder="Enter your 10-digit mobile number" type="tel" inputmode="numeric"
                                        pattern="[0-9]*" />
                                </div>
                            </label>
                            <div id="recaptcha-container" class="flex justify-center"></div>
                             <p id="error-message" class="text-red-500 text-sm text-center"></p>
                            <button id="send-otp-button"
                                class="flex w-full cursor-pointer items-center justify-center rounded-lg h-12 px-5 bg-primary text-white text-base font-bold tracking-wider">
                                <span>Send OTP</span>
                            </button>
                        </div>
                    </div>
                    <div id="otp-section" class="pt-8 text-base font-semibold leading-7 hidden">
                        <div class="flex flex-col items-center gap-4">
                            <h3 class="text-[#111418] dark:text-white tracking-light text-xl font-bold">
                                Enter OTP
                            </h3>
                            <p class="text-[#617589] dark:text-gray-400 text-sm font-normal text-center">
                                An OTP has been sent to your mobile number for verification.
                            </p>
                            <fieldset id="otp-fieldset" class="relative flex gap-2 sm:gap-4">
                                <input
                                    class="otp-input flex h-12 w-10 sm:h-14 sm:w-12 text-center [appearance:textfield] focus:outline-0 focus:ring-0 [&amp;::-webkit-inner-spin-button]:appearance-none [&amp;::-webkit-outer-spin-button]:appearance-none rounded-md border border-[#dbe0e6] bg-white dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:border-primary focus:ring-2 focus:ring-primary/50 text-base font-normal leading-normal"
                                    maxlength="1" type="text" inputmode="numeric" pattern="[0-9]*" value="" />
                                <input
                                    class="otp-input flex h-12 w-10 sm:h-14 sm:w-12 text-center [appearance:textfield] focus:outline-0 focus:ring-0 [&amp;::-webkit-inner-spin-button]:appearance-none [&amp;::-webkit-outer-spin-button]:appearance-none rounded-md border border-[#dbe0e6] bg-white dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:border-primary focus:ring-2 focus:ring-primary/50 text-base font-normal leading-normal"
                                    maxlength="1" type="text" inputmode="numeric" pattern="[0-9]*" value="" />
                                <input
                                    class="otp-input flex h-12 w-10 sm:h-14 sm:w-12 text-center [appearance:textfield] focus:outline-0 focus:ring-0 [&amp;::-webkit-inner-spin-button]:appearance-none [&amp;::-webkit-outer-spin-button]:appearance-none rounded-md border border-[#dbe0e6] bg-white dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:border-primary focus:ring-2 focus:ring-primary/50 text-base font-normal leading-normal"
                                    maxlength="1" type="text" inputmode="numeric" pattern="[0-9]*" value="" />
                                <input
                                    class="otp-input flex h-12 w-10 sm:h-14 sm:w-12 text-center [appearance:textfield] focus:outline-0 focus:ring-0 [&amp;::-webkit-inner-spin-button]:appearance-none [&amp;::-webkit-outer-spin-button]:appearance-none rounded-md border border-[#dbe0e6] bg-white dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:border-primary focus:ring-2 focus:ring-primary/50 text-base font-normal leading-normal"
                                    maxlength="1" type="text" inputmode="numeric" pattern="[0-9]*" value="" />
                                <input
                                    class="otp-input flex h-12 w-10 sm:h-14 sm:w-12 text-center [appearance:textfield] focus:outline-0 focus:ring-0 [&amp;::-webkit-inner-spin-button]:appearance-none [&amp;::-webkit-outer-spin-button]:appearance-none rounded-md border border-[#dbe0e6] bg-white dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:border-primary focus:ring-2 focus:ring-primary/50 text-base font-normal leading-normal"
                                    maxlength="1" type="text" inputmode="numeric" pattern="[0-9]*" value="" />
                                <input
                                    class="otp-input flex h-12 w-10 sm:h-14 sm:w-12 text-center [appearance:textfield] focus:outline-0 focus:ring-0 [&amp;::-webkit-inner-spin-button]:appearance-none [&amp;::-webkit-outer-spin-button]:appearance-none rounded-md border border-[#dbe0e6] bg-white dark:bg-gray-800 dark:border-gray-700 dark:text-white focus:border-primary focus:ring-2 focus:ring-primary/50 text-base font-normal leading-normal"
                                    maxlength="1" type="text" inputmode="numeric" pattern="[0-9]*" value="" />
                            </fieldset>
                            <button id="verify-otp-button"
                                class="flex w-full cursor-pointer items-center justify-center rounded-lg h-12 px-5 bg-primary text-white text-base font-bold tracking-wider mt-4">
                                <span>Verify OTP</span>
                            </button>
                            <div class="flex items-center justify-between w-full text-sm">
                                <a class="font-semibold text-primary hover:text-primary/80" href="#">Resend OTP</a>
                                <a class="font-semibold text-gray-600 dark:text-gray-400 hover:text-gray-500"
                                    href="#">Need Help?</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-6 text-xs text-gray-400 dark:text-gray-500">
                    <p>© 2023 Khatu Shyam Enterprises. All rights reserved.</p>
                    <div class="flex justify-center gap-4 mt-2">
                        <a class="hover:text-primary" href="#">Privacy Policy</a>
                        <a class="hover:text-primary" href="#">Terms of Service</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const otpFieldSet = document.getElementById('otp-fieldset');
        const otpInputs = otpFieldSet.querySelectorAll('.otp-input');

        otpInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                const value = e.target.value;
                if (value.length > 0 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && input.value === '' && index > 0) {
                    otpInputs[index - 1].focus();
                } else if (e.key === 'ArrowLeft' && index > 0) {
                    otpInputs[index - 1].focus();
                } else if (e.key === 'ArrowRight' && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });

            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pasteData = e.clipboardData.getData('text');
                const otpArray = pasteData.split('').slice(0, otpInputs.length);
                otpArray.forEach((char, i) => {
                    otpInputs[i].value = char;
                });
                const nextFocusIndex = Math.min(otpInputs.length - 1, pasteData.length);
                otpInputs[nextFocusIndex].focus();
            });
        });
    </script>
     <script>
        window.onload = function () {
            const phoneNumberInput = document.getElementById('phone-number-input');
            const sendOtpButton = document.getElementById('send-otp-button');
            const verifyOtpButton = document.getElementById('verify-otp-button');
            const otpSection = document.getElementById('otp-section');
            const errorMessage = document.getElementById('error-message');

            // Initialize reCAPTCHA verifier
            window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'invisible',
                'callback': (response) => {
                    // reCAPTCHA solved, allow signInWithPhoneNumber.
                    console.log("reCAPTCHA solved");
                }
            });

            sendOtpButton.addEventListener('click', () => {
                const countryCode = document.getElementById('country-code-select').value;
                const phoneNumber = phoneNumberInput.value;
                const appVerifier = window.recaptchaVerifier;
                const fullPhoneNumber = countryCode + phoneNumber;

                auth.signInWithPhoneNumber(fullPhoneNumber, appVerifier)
                    .then((confirmationResult) => {
                        console.log("OTP sent");
                        window.confirmationResult = confirmationResult;
                        otpSection.classList.remove('hidden');
                        errorMessage.textContent = '';
                    }).catch((error) => {
                        console.error("Error sending OTP:", error);
                        errorMessage.textContent = "Error sending OTP. Please try again.";
                        recaptchaVerifier.render().then(function(widgetId) {
                           grecaptcha.reset(widgetId);
                        });
                    });
            });

            verifyOtpButton.addEventListener('click', () => {
                const verificationCode = Array.from(document.querySelectorAll('.otp-input')).map(input => input.value).join('');
                const errorMessage = document.getElementById('error-message');

                if (!verificationCode || verificationCode.length !== 6) {
                    errorMessage.textContent = 'Please enter a valid 6-digit OTP.';
                    return;
                }
                
                confirmationResult.confirm(verificationCode).then(async (result) => {
                    const user = result.user;
                    const phoneNumber = user.phoneNumber;
                    
                    try {
                        // Pehle check karein ki user already exist karta hai ya nahi
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        
                        if (!userDoc.exists) {
                            // Naya user hai, to Firestore mein save karein
                            await db.collection('users').doc(user.uid).set({
                                phoneNumber: phoneNumber,
                                uid: user.uid,
                                khatu_website_admin: false, // Default admin status
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                name: phoneNumber, // Default name phone number hai
                                email: '', // Blank email
                                address: '' // Blank address
                            });
                            
                            console.log('New user added to Firestore database');
                        } else {
                            console.log('User already exists in database');
                        }
                        
                        // User role check karein aur redirect karein
                        const userData = await db.collection('users').doc(user.uid).get();
                        const isAdmin = userData.data().khatu_website_admin;
                        
                        if (isAdmin === true) {
                            window.location.href = 'admin_dashboard.html';
                        } else {
                            window.location.href = 'dashboard.html';
                        }
                        
                    } catch (error) {
                        console.error('Error saving user to database:', error);
                        errorMessage.textContent = 'Login successful but error saving user data. Please contact support.';
                    }
                    
                }).catch((error) => {
                    errorMessage.textContent = 'Invalid verification code. Please try again.';
                    console.error('Verification error:', error);
                });
            });
        }
    </script>
</body>
</html>